name: Terragrunt Action Workflow GCP Prod

on:
  workflow_call:
    inputs:
      workingDirectory:
        description: "Path to the working directory"
        required: true
        type: string
      environment:
        description: "Name of the environment"
        required: true
        type: string
      tfLog:
        description: Terraform log level
        required: false
        type: string
        default: 'ERROR'
      terraformVersion:
        description: "Terraform version to install"
        required: false
        type: string
        default: '1.10.3'
      terragruntVersion:
        description: "Terragrunt version to install"
        required: false
        type: string
        default: '0.68.16'
      checkovSkipChecks:
        description: "Comma-separated list of Checkov checks to skip"
        required: false
        type: string
        default: ''
    secrets:
      TERRAGRUNT_GITHUB_ORG_TOKEN:
        required: true
      GCP_PROD_PROJECT_ID:
        required: true
      GCP_PROD_WORKLOAD_IDENTITY_PROVIDER:
        required: true

jobs:
  terragrunt-plan:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'
      pull-requests: 'write'  # Required for PR comments
    env:
      TERRAGRUNT_GITHUB_ORG_TOKEN: ${{ secrets.TERRAGRUNT_GITHUB_ORG_TOKEN }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ inputs.terraformVersion }}
          terraform_wrapper: false

      - name: Setup Terragrunt
        run: |
          TERRAGRUNT_VERSION="${{ inputs.terragruntVersion }}"
          echo "Installing Terragrunt version ${TERRAGRUNT_VERSION}..."
          
          # Download Terragrunt binary
          wget -q https://github.com/gruntwork-io/terragrunt/releases/download/v${TERRAGRUNT_VERSION}/terragrunt_linux_amd64 -O terragrunt
          
          # Make executable
          chmod +x terragrunt
          
          # Move to PATH
          sudo mv terragrunt /usr/local/bin/terragrunt
          
          # Verify installation
          terragrunt --version
          terraform --version

      - name: GCP Auth
        uses: AjitPunchhiInutive/gh-actions-library/.github/actions/gcp/auth@main
        with:
          project_id: ${{ secrets.GCP_PROD_PROJECT_ID }}
          workload_identity_provider: ${{ secrets.GCP_PROD_WORKLOAD_IDENTITY_PROVIDER }}

      - name: Terragrunt Init
        uses: AjitPunchhiInutive/gh-actions-library/.github/actions/terragrunt/init@main
        with:
          workingDirectory: ${{ inputs.workingDirectory }}
          environment: ${{ inputs.environment }}
          tfLog: ${{ inputs.tfLog }}

      - name: Terragrunt Validate
        uses: AjitPunchhiInutive/gh-actions-library/.github/actions/terragrunt/validate@main
        with:
          workingDirectory: ${{ inputs.workingDirectory }}
          environment: ${{ inputs.environment }}
          tfLog: ${{ inputs.tfLog }}

      - name: Terragrunt Lint
        uses: AjitPunchhiInutive/gh-actions-library/.github/actions/terragrunt/lint@main
        with:
          workingDirectory: ${{ inputs.workingDirectory }}
          environment: ${{ inputs.environment }}
          tfLog: ${{ inputs.tfLog }}

      # Checkov Security Scan
      - name: Run Checkov Security Scan
        id: checkov
        uses: bridgecrewio/checkov-action@master
        with:
          directory: ${{ inputs.workingDirectory }}
          framework: terraform
          output_format: cli,sarif
          output_file_path: console,checkov-results.sarif
          soft_fail: false  # Set to true to not fail the workflow on security issues
          skip_check: ${{ inputs.checkovSkipChecks }}
          download_external_modules: true
          quiet: false
        continue-on-error: true  # Continue to show results even if checks fail

      - name: Upload Checkov Results to GitHub Security
        uses: AjitPunchhiInutive/gh-actions-library/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: checkov-results.sarif
          category: checkov

      - name: Checkov Results Summary
        if: always()
        run: |
          if [ -f checkov-results.sarif ]; then
            echo "### Checkov Security Scan Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Checkov scan completed. Check the Security tab for detailed results." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ "${{ steps.checkov.outcome }}" == "failure" ]; then
              echo "âš ï¸ Security issues detected. Review the findings before proceeding." >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… No critical security issues found." >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: Terragrunt Plan
        id: plan
        uses: AjitPunchhiInutive/gh-actions-library/.github/actions/terragrunt/plan@main
        with:
          workingDirectory: ${{ inputs.workingDirectory }}
          environment: ${{ inputs.environment }}
          tfLog: ${{ inputs.tfLog }}

      - name: Upload TF Plan
        uses: actions/upload-artifact@v4
        with:
          name: tf-plan
          path: ${{ github.workspace }}/${{ inputs.workingDirectory }}/tfplan.out
          retention-days: 30

      # Comment on PR with plan results
      - name: Comment PR with Plan Results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `### Terragrunt Plan Results for \`${{ inputs.workingDirectory }}\`
            
            #### Checkov Security Scan: \`${{ steps.checkov.outcome }}\`
            #### Terraform Validation: âœ…
            #### Terraform Plan: \`${{ steps.plan.outcome }}\`
            
            <details>
            <summary>Show Plan Details</summary>
            
            \`\`\`
            Plan file generated successfully and uploaded as artifact.
            Review the full plan in the workflow run.
            \`\`\`
            
            </details>
            
            **Environment:** \`${{ inputs.environment }}\`
            **Working Directory:** \`${{ inputs.workingDirectory }}\`
            
            ${steps.checkov.outcome === 'failure' ? 'âš ï¸ **Security issues detected by Checkov. Review before merging.**' : ''}
            
            *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`, Workflow: \`${{ github.workflow }}\`*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

  # Manual approval gate for PRs
  approval-gate:
    if: github.event_name == 'pull_request'
    needs: terragrunt-plan
    runs-on: ubuntu-latest
    environment: 
      name: prod-approval  # This environment should have required reviewers configured
    permissions:
      contents: 'read'
    
    steps:
      - name: Manual Approval Required
        run: |
          echo "### ðŸ” Manual Approval Required" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This pull request requires manual approval before it can be merged." >> $GITHUB_STEP_SUMMARY
          echo "Review the Terragrunt plan and Checkov security scan results." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Reviewer:** Please verify:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Checkov security scan passed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Terraform plan is correct" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… No unintended infrastructure changes" >> $GITHUB_STEP_SUMMARY

  terragrunt-apply:
    needs: terragrunt-plan
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
    environment: prod  # This environment should also have required reviewers configured
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'
    env:
      TERRAGRUNT_GITHUB_ORG_TOKEN: ${{ secrets.TERRAGRUNT_GITHUB_ORG_TOKEN }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ inputs.terraformVersion }}
          terraform_wrapper: false

      - name: Setup Terragrunt
        run: |
          TERRAGRUNT_VERSION="${{ inputs.terragruntVersion }}"
          echo "Installing Terragrunt version ${TERRAGRUNT_VERSION}..."
          wget -q https://github.com/gruntwork-io/terragrunt/releases/download/v${TERRAGRUNT_VERSION}/terragrunt_linux_amd64 -O terragrunt
          chmod +x terragrunt
          sudo mv terragrunt /usr/local/bin/terragrunt
          terragrunt --version

      - name: GCP Auth
        uses: AjitPunchhiInutive/gh-actions-library/.github/actions/gcp/auth@main
        with:
          project_id: ${{ secrets.GCP_PROD_PROJECT_ID }}
          workload_identity_provider: ${{ secrets.GCP_PROD_WORKLOAD_IDENTITY_PROVIDER }}
      
      - name: Download TF Plan
        uses: actions/download-artifact@v4
        with:
          name: tf-plan
          path: ${{ inputs.workingDirectory }}

      - name: Terragrunt Apply
        uses: AjitPunchhiInutive/gh-actions-library/.github/actions/terragrunt/apply@main
        with:
          workingDirectory: ${{ inputs.workingDirectory }}
          environment: ${{ inputs.environment }}
          tfLog: ${{ inputs.tfLog }}

      - name: Apply Summary
        if: always()
        run: |
          echo "### ðŸš€ Terragrunt Apply Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** \`${{ inputs.environment }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Working Directory:** \`${{ inputs.workingDirectory }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
