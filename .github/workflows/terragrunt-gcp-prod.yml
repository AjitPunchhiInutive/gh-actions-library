# ─────────────────────────────────────────────────────────────────────────────
# Terragrunt Action Workflow - GCP Prod
# Handles: Plan → Manual Approval → Apply
# ─────────────────────────────────────────────────────────────────────────────

name: Terragrunt Action Workflow GCP Prod

on:
  workflow_call:
    inputs:
      workingDirectory:
        description: "Path to the working directory"
        required: true
        type: string
      environment:
        description: "Name of the environment"
        required: true
        type: string
      tfLog:
        description: "Terraform log level"
        required: false
        type: string
        default: "ERROR"
      terraformVersion:
        description: "Terraform version to install"
        required: false
        type: string
        default: "1.10.3"
      terragruntVersion:
        description: "Terragrunt version to install"
        required: false
        type: string
        default: "0.68.16"
      # runSecurityScan:
      #   description: "Enable or disable TFSec security scan"
      #   required: false
      #   type: boolean
      #   default: true
    secrets:
      TERRAGRUNT_GITHUB_ORG_TOKEN:
        required: true
      GCP_PROD_PROJECT_ID:
        required: true
      GCP_PROD_WORKLOAD_IDENTITY_PROVIDER:
        required: true

# ─────────────────────────────────────────────────────────────────────────────
# PLAN JOB
# ─────────────────────────────────────────────────────────────────────────────
jobs:
  terragrunt-plan:
    runs-on: ubuntu-latest
    permissions:
      contents: "read"
      id-token: "write"
    env:
      TERRAGRUNT_GITHUB_ORG_TOKEN: ${{ secrets.TERRAGRUNT_GITHUB_ORG_TOKEN }}
      TF_LOG: ${{ inputs.tfLog }}
      TF_IN_AUTOMATION: "true"

    steps:
      # ── Checkout ──────────────────────────────────────────────────────────
      - name: Checkout Repository
        uses: actions/checkout@v4

      # ── Setup Tools ───────────────────────────────────────────────────────
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ inputs.terraformVersion }}
          terraform_wrapper: false

      - name: Setup Terragrunt
        run: |
          TERRAGRUNT_VERSION="${{ inputs.terragruntVersion }}"
          echo "Installing Terragrunt v${TERRAGRUNT_VERSION}..."
          wget -q "https://github.com/gruntwork-io/terragrunt/releases/download/v${TERRAGRUNT_VERSION}/terragrunt_linux_amd64" -O terragrunt
          chmod +x terragrunt
          sudo mv terragrunt /usr/local/bin/terragrunt
          echo "━━━ Versions ━━━"
          terragrunt --version
          terraform --version

      # ── Auth ──────────────────────────────────────────────────────────────
      - name: GCP Auth
        uses: AjitPunchhiInutive/gh-actions-library/.github/actions/gcp/auth@main
        with:
          project_id: ${{ secrets.GCP_PROD_PROJECT_ID }}
          workload_identity_provider: ${{ secrets.GCP_PROD_WORKLOAD_IDENTITY_PROVIDER }}

      # ── Debug ─────────────────────────────────────────────────────────────
      - name: Debug - Check Directory Structure
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo " Debug Info"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "Current Directory   : $(pwd)"
          echo "Working Directory   : ${{ inputs.workingDirectory }}"
          echo "Directory Contents  :"
          ls -la "${{ inputs.workingDirectory }}" || echo "Directory not found"
          echo "Terragrunt Files    :"
          find . -name "terragrunt.hcl" -type f

      # ── Init ──────────────────────────────────────────────────────────────
      - name: Terragrunt Init
        working-directory: ${{ inputs.workingDirectory }}
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo " Terragrunt Init"
          echo " Directory: $(pwd)"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          terragrunt init -reconfigure

      # ── Validate ──────────────────────────────────────────────────────────
      - name: Terragrunt Validate
        working-directory: ${{ inputs.workingDirectory }}
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo " Terragrunt Validate"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          terragrunt validate

      # ── Format Check ──────────────────────────────────────────────────────
      - name: Terragrunt Format Check
        working-directory: ${{ inputs.workingDirectory }}
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo " Format Check"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          terragrunt hclfmt --terragrunt-check || echo "HCL format check completed"
          terraform fmt -check -recursive || echo "TF format check completed"

      # ── Security Scan with TFSec ──────────────────────────────────────────
      - name: TFSec Security Scan
        uses: AjitPunchhiInutive/gh-actions-library/.github/actions/tfsec@main
        with:
          working-directory: ${{ inputs.workingDirectory }}

      # ── Plan ──────────────────────────────────────────────────────────────
      - name: Terragrunt Plan
        working-directory: ${{ inputs.workingDirectory }}
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo " Terragrunt Plan"
          echo " Directory   : $(pwd)"
          echo " Environment : ${{ inputs.environment }}"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

          PLAN_FILE="$(pwd)/tfplan.out"
          echo "Plan file path: ${PLAN_FILE}"

          terragrunt plan -out="${PLAN_FILE}"

          if [ -f "${PLAN_FILE}" ]; then
            echo " Plan file created: $(ls -lh ${PLAN_FILE} | awk '{print $9, $5}')"
          else
            echo " Error: Plan file not created at ${PLAN_FILE}"
            find . -name "tfplan.out" -type f
            exit 1
          fi

      # ── Upload Plan Artifact ──────────────────────────────────────────────
      - name: Upload TF Plan
        uses: actions/upload-artifact@v4
        with:
          name: tf-plan-${{ inputs.environment }}
          path: ${{ inputs.workingDirectory }}/tfplan.out
          retention-days: 30
          if-no-files-found: error

# ─────────────────────────────────────────────────────────────────────────────
# MANUAL APPROVAL JOB
# ─────────────────────────────────────────────────────────────────────────────
  manual-approval:
    needs: terragrunt-plan
    runs-on: ubuntu-latest
    environment:
      name: prod
      url: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
    steps:
      - name: Manual Approval Gate
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "⏸️  Waiting for Manual Approval"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo " Environment      : ${{ inputs.environment }}"
          echo " Working Directory: ${{ inputs.workingDirectory }}"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo " Approval granted — proceeding to apply"

# ─────────────────────────────────────────────────────────────────────────────
# APPLY JOB
# ─────────────────────────────────────────────────────────────────────────────
  terragrunt-apply:
    needs: manual-approval
    runs-on: ubuntu-latest
    environment: prod
    permissions:
      contents: "read"
      id-token: "write"
    env:
      TERRAGRUNT_GITHUB_ORG_TOKEN: ${{ secrets.TERRAGRUNT_GITHUB_ORG_TOKEN }}
      TF_LOG: ${{ inputs.tfLog }}
      TF_IN_AUTOMATION: "true"

    steps:
      # ── Checkout ──────────────────────────────────────────────────────────
      - name: Checkout Repository
        uses: actions/checkout@v4

      # ── Setup Tools ───────────────────────────────────────────────────────
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ inputs.terraformVersion }}
          terraform_wrapper: false

      - name: Setup Terragrunt
        run: |
          TERRAGRUNT_VERSION="${{ inputs.terragruntVersion }}"
          echo "Installing Terragrunt v${TERRAGRUNT_VERSION}..."
          wget -q "https://github.com/gruntwork-io/terragrunt/releases/download/v${TERRAGRUNT_VERSION}/terragrunt_linux_amd64" -O terragrunt
          chmod +x terragrunt
          sudo mv terragrunt /usr/local/bin/terragrunt
          echo "━━━ Versions ━━━"
          terragrunt --version
          terraform --version

      # ── Auth ──────────────────────────────────────────────────────────────
      - name: GCP Auth
        uses: AjitPunchhiInutive/gh-actions-library/.github/actions/gcp/auth@main
        with:
          project_id: ${{ secrets.GCP_PROD_PROJECT_ID }}
          workload_identity_provider: ${{ secrets.GCP_PROD_WORKLOAD_IDENTITY_PROVIDER }}

      # ── Download Plan ─────────────────────────────────────────────────────
      - name: Download TF Plan
        uses: actions/download-artifact@v4
        with:
          name: tf-plan-${{ inputs.environment }}
          path: ${{ inputs.workingDirectory }}

      # ── Verify Plan ───────────────────────────────────────────────────────
      - name: Verify Plan File
        working-directory: ${{ inputs.workingDirectory }}
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo " Verifying Plan File"
          echo " Directory: $(pwd)"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          ls -la
          if [ -f "tfplan.out" ]; then
            echo " Plan file found: $(ls -lh tfplan.out | awk '{print $9, $5}')"
          else
            echo " Error: Plan file not found!"
            exit 1
          fi

      # ── Init ──────────────────────────────────────────────────────────────
      - name: Terragrunt Init
        working-directory: ${{ inputs.workingDirectory }}
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo " Terragrunt Init (for apply)"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          terragrunt init -reconfigure

      # ── Apply ─────────────────────────────────────────────────────────────
      - name: Terragrunt Apply
        working-directory: ${{ inputs.workingDirectory }}
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo " Terragrunt Apply"
          echo " Directory   : $(pwd)"
          echo " Environment : ${{ inputs.environment }}"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

          PLAN_FILE="$(pwd)/tfplan.out"

          terragrunt apply -auto-approve "${PLAN_FILE}"

          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo " Apply completed successfully"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"