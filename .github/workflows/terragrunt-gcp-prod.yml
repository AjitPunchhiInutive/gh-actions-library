name: Terragrunt Action Workflow GCP Prod

on:
  workflow_call:
    inputs:
      workingDirectory:
        description: "Path to the working directory"
        required: true
        type: string
      environment:
        description: "Name of the environment"
        required: true
        type: string
      tfLog:
        description: Terraform log level
        required: false
        type: string
        default: 'ERROR'
      terraformVersion:
        description: "Terraform version to install"
        required: false
        type: string
        default: '1.10.3'
      terragruntVersion:
        description: "Terragrunt version to install"
        required: false
        type: string
        default: '0.68.16'
      checkov_Version:
        description: "Checkov version to install (e.g., 3.2.0 or latest)"
        required: false
        type: string
        default: ''
      checkovSkipChecks:
        description: "Comma-separated list of Checkov checks to skip"
        required: false
        type: string
        default: ''
    secrets:
      TERRAGRUNT_GITHUB_ORG_TOKEN:
        required: true
      GCP_PROD_PROJECT_ID:
        required: true
      GCP_PROD_WORKLOAD_IDENTITY_PROVIDER:
        required: true

jobs:
  terragrunt-plan:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'
      pull-requests: 'write'  # For Checkov comments
    env:
      TERRAGRUNT_GITHUB_ORG_TOKEN: ${{ secrets.TERRAGRUNT_GITHUB_ORG_TOKEN }}
      TF_LOG: ${{ inputs.tfLog }}
      TF_IN_AUTOMATION: 'true'
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ inputs.terraformVersion }}
          terraform_wrapper: false

      - name: Setup Terragrunt
        run: |
          TERRAGRUNT_VERSION="${{ inputs.terragruntVersion }}"
          echo "Installing Terragrunt version ${TERRAGRUNT_VERSION}..."
          
          # Download Terragrunt binary
          wget -q https://github.com/gruntwork-io/terragrunt/releases/download/v${TERRAGRUNT_VERSION}/terragrunt_linux_amd64 -O terragrunt
          
          # Make executable
          chmod +x terragrunt
          
          # Move to PATH
          sudo mv terragrunt /usr/local/bin/terragrunt
          
          # Verify installation
          terragrunt --version
          terraform --version

      - name: GCP Auth
        uses: AjitPunchhiInutive/gh-actions-library/.github/actions/gcp/auth@main
        with:
          project_id: ${{ secrets.GCP_PROD_PROJECT_ID }}
          workload_identity_provider: ${{ secrets.GCP_PROD_WORKLOAD_IDENTITY_PROVIDER }}

      - name: Debug - Check Directory Structure
        run: |
          echo "=== Current Directory ==="
          pwd
          echo "=== Working Directory Input ==="
          echo "${{ inputs.workingDirectory }}"
          echo "=== Check if directory exists ==="
          ls -la ${{ inputs.workingDirectory }} || echo "Directory not found"
          echo "=== Find terragrunt.hcl files ==="
          find . -name "terragrunt.hcl" -type f

      - name: Terragrunt Init
        working-directory: ${{ inputs.workingDirectory }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo " Terragrunt Init"
          echo " Directory: $(pwd)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          terragrunt init -reconfigure

      - name: Install Checkov
        uses: AjitPunchhiInutive/gh-actions-library/.github/checkov@main
        with:
          checkovVersion: ${{ inputs.checkov_version }}

      # - name: Install Checkov
      #   run: |
      #     echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      #     echo " Installing Checkov"
      #     echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      #     pip install checkov
      #     checkov --version

      - name: Run Checkov Security Scan
        working-directory: ${{ inputs.workingDirectory }}
        continue-on-error: true
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo " Running Checkov Security Scan"
          echo " Directory: $(pwd)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Prepare skip checks argument
          SKIP_CHECKS="${{ inputs.checkovSkipChecks }}"
          SKIP_ARG=""
          if [ -n "${SKIP_CHECKS}" ]; then
            SKIP_ARG="--skip-check ${SKIP_CHECKS}"
          fi
          
          # Find Terraform files in cache
          CACHE_DIR=$(find .terragrunt-cache -type d -name "*.tf" -exec dirname {} \; | head -n 1)
          
          if [ -n "${CACHE_DIR}" ]; then
            echo "Scanning Terraform files in: ${CACHE_DIR}"
            checkov -d "${CACHE_DIR}" \
              --framework terraform \
              --output cli \
              --output junitxml \
              --output-file-path . \
              --soft-fail ${SKIP_ARG} || true
          else
            echo "  No Terraform cache directory found, scanning working directory"
            checkov -d . \
              --framework terraform \
              --output cli \
              --output junitxml \
              --output-file-path . \
              --soft-fail ${SKIP_ARG} || true
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo " Checkov scan completed"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Upload Checkov Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: checkov-results-${{ inputs.environment }}
          path: |
            ${{ inputs.workingDirectory }}/results_*.xml
            ${{ inputs.workingDirectory }}/results_*.json
          retention-days: 30
          if-no-files-found: ignore

      - name: Terragrunt Validate
        working-directory: ${{ inputs.workingDirectory }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo " Terragrunt Validate"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          terragrunt validate

      - name: Terragrunt Format Check
        working-directory: ${{ inputs.workingDirectory }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo " Terragrunt Format Check"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          terragrunt hclfmt --terragrunt-check || echo "Format check completed"
          terraform fmt -check -recursive || echo "Format check completed"

      - name: Terragrunt Plan
        working-directory: ${{ inputs.workingDirectory }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo " Terragrunt Plan"
          echo " Directory: $(pwd)"
          echo "  Environment: ${{ inputs.environment }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Use absolute path for plan file to avoid cache directory issues
          PLAN_FILE="$(pwd)/tfplan.out"
          echo "Plan file path: ${PLAN_FILE}"
          
          # Run plan with absolute path
          terragrunt plan -out="${PLAN_FILE}"
          
          # Verify plan file was created
          if [ -f "${PLAN_FILE}" ]; then
            echo " Plan file created: $(ls -lh ${PLAN_FILE} | awk '{print $9, $5}')"
          else
            echo " Error: Plan file not created at ${PLAN_FILE}"
            echo "Checking for plan files in cache directories..."
            find . -name "tfplan.out" -type f
            exit 1
          fi

      - name: Upload TF Plan
        uses: actions/upload-artifact@v4
        with:
          name: tf-plan-${{ inputs.environment }}
          path: ${{ inputs.workingDirectory }}/tfplan.out
          retention-days: 30
          if-no-files-found: error

  manual-approval:
    needs: terragrunt-plan
    runs-on: ubuntu-latest
    environment: 
      name: prod
      url: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
    steps:
      - name: Manual Approval Required
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â¸ï¸  Waiting for Manual Approval"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Environment: ${{ inputs.environment }}"
          echo "Working Directory: ${{ inputs.workingDirectory }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo " Approval granted - proceeding to apply"

  terragrunt-apply:
    needs: manual-approval
    environment: prod
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'
    env:
      TERRAGRUNT_GITHUB_ORG_TOKEN: ${{ secrets.TERRAGRUNT_GITHUB_ORG_TOKEN }}
      TF_LOG: ${{ inputs.tfLog }}
      TF_IN_AUTOMATION: 'true'
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ inputs.terraformVersion }}
          terraform_wrapper: false

      - name: Setup Terragrunt
        run: |
          TERRAGRUNT_VERSION="${{ inputs.terragruntVersion }}"
          echo "Installing Terragrunt version ${TERRAGRUNT_VERSION}..."
          wget -q https://github.com/gruntwork-io/terragrunt/releases/download/v${TERRAGRUNT_VERSION}/terragrunt_linux_amd64 -O terragrunt
          chmod +x terragrunt
          sudo mv terragrunt /usr/local/bin/terragrunt
          terragrunt --version
          terraform --version

      - name: GCP Auth
        uses: AjitPunchhiInutive/gh-actions-library/.github/actions/gcp/auth@main
        with:
          project_id: ${{ secrets.GCP_PROD_PROJECT_ID }}
          workload_identity_provider: ${{ secrets.GCP_PROD_WORKLOAD_IDENTITY_PROVIDER }}
      
      - name: Download TF Plan
        uses: actions/download-artifact@v4
        with:
          name: tf-plan-${{ inputs.environment }}
          path: ${{ inputs.workingDirectory }}

      - name: Verify Plan File
        working-directory: ${{ inputs.workingDirectory }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo " Verifying Plan File"
          echo " Directory: $(pwd)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          ls -la
          
          if [ -f "tfplan.out" ]; then
            echo " Plan file found: $(ls -lh tfplan.out | awk '{print $9, $5}')"
          else
            echo " Error: Plan file not found!"
            exit 1
          fi

      - name: Terragrunt Init (for apply)
        working-directory: ${{ inputs.workingDirectory }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”§ Terragrunt Init (for apply)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          terragrunt init -reconfigure

      - name: Terragrunt Apply
        if: github.ref == 'refs/heads/main'
        working-directory: ${{ inputs.workingDirectory }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo " Terragrunt Apply"
          echo " Directory: $(pwd)"
          echo "  Environment: ${{ inputs.environment }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Use absolute path for apply
          PLAN_FILE="$(pwd)/tfplan.out"
          
          # Apply the plan file
          terragrunt apply "${PLAN_FILE}"
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo " Apply completed successfully"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"