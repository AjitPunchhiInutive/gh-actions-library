name: 'Install and Run Checkov'
description: 'Install Checkov security scanner and run scans with Terragrunt support'

inputs:
  # Installation inputs
  version:
    description: 'Checkov version to install'
    required: false
    default: '3.2.499'
  
  python-version:
    description: 'Python version to use'
    required: false
    default: '3.12'

  # Scan configuration inputs
  run-scan:
    description: 'Whether to run security scan after installation'
    required: false
    default: 'true'

  workingDirectory:
    description: 'Working directory for Checkov scan'
    required: false
    default: '.'

  checkovSkipChecks:
    description: 'Comma-separated list of checks to skip'
    required: false
    default: ''

  scan-terragrunt-cache:
    description: 'Scan Terragrunt cache directory if found'
    required: false
    default: 'true'

  output-format:
    description: 'Output format (cli, json, junitxml, sarif, github_failed_only)'
    required: false
    default: 'cli,junitxml'

  framework:
    description: 'IaC framework to scan (terraform, kubernetes, dockerfile, all)'
    required: false
    default: 'terraform'

  soft-fail:
    description: 'Do not fail the build if security issues are found'
    required: false
    default: 'true'

  # Terraform validation inputs
  validate-terraform:
    description: 'Run Terraform validation checks before Checkov scan'
    required: false
    default: 'true'

  terraform-version:
    description: 'Terraform version to install for validation'
    required: false
    default: 'latest'

  check-formatting:
    description: 'Check Terraform file formatting'
    required: false
    default: 'true'

  fail-on-validation-error:
    description: 'Fail the workflow if Terraform validation errors are found'
    required: false
    default: 'false'

outputs:
  checkov-version:
    description: 'Installed Checkov version'
    value: ${{ steps.install.outputs.version }}
  
  scan-completed:
    description: 'Whether scan was completed'
    value: ${{ steps.scan.outputs.completed }}

  scan-directory:
    description: 'Directory that was scanned'
    value: ${{ steps.scan.outputs.scanned-dir }}

  terraform-validation:
    description: 'Terraform validation status'
    value: ${{ steps.tf-validate.outputs.status }}

  terraform-formatting:
    description: 'Terraform formatting check status'
    value: ${{ steps.tf-format.outputs.status }}

runs:
  using: 'composite'
  steps:
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ inputs.python-version }}

    - name: Setup Terraform
      if: inputs.validate-terraform == 'true' && inputs.framework == 'terraform'
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ inputs.terraform-version }}

    - name: Terraform Format Check
      id: tf-format
      if: inputs.validate-terraform == 'true' && inputs.check-formatting == 'true' && inputs.framework == 'terraform'
      shell: bash
      working-directory: ${{ inputs.workingDirectory }}
      continue-on-error: ${{ inputs.fail-on-validation-error == 'false' }}
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ðŸ“ Checking Terraform Formatting"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        
        # Find all .tf files
        TF_FILES=$(find . -type f -name "*.tf" ! -path "*/.terragrunt-cache/*" ! -path "*/.terraform/*")
        
        if [ -z "$TF_FILES" ]; then
          echo "âš ï¸  No Terraform files found"
          echo "status=skipped" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        echo "Found Terraform files:"
        echo "$TF_FILES" | sed 's/^/  /'
        echo ""
        
        # Run terraform fmt check
        FORMAT_ERRORS=0
        terraform fmt -check -recursive -diff . || FORMAT_ERRORS=$?
        
        if [ $FORMAT_ERRORS -eq 0 ]; then
          echo ""
          echo "âœ… All Terraform files are properly formatted"
          echo "status=passed" >> $GITHUB_OUTPUT
        else
          echo ""
          echo "âŒ Formatting issues found. Run 'terraform fmt -recursive' to fix."
          echo "status=failed" >> $GITHUB_OUTPUT
          
          # Add to GitHub summary
          echo "## âš ï¸ Terraform Formatting Issues" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Some Terraform files are not properly formatted." >> $GITHUB_STEP_SUMMARY
          echo "Run the following command to fix:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "terraform fmt -recursive" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ inputs.fail-on-validation-error }}" = "true" ]; then
            exit 1
          fi
        fi
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    - name: Terraform Syntax Validation
      id: tf-validate
      if: inputs.validate-terraform == 'true' && inputs.framework == 'terraform'
      shell: bash
      working-directory: ${{ inputs.workingDirectory }}
      continue-on-error: ${{ inputs.fail-on-validation-error == 'false' }}
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ðŸ” Validating Terraform Syntax"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        
        VALIDATION_ERRORS=0
        TOTAL_DIRS=0
        VALIDATED_DIRS=0
        FAILED_DIRS=""
        
        # Find directories containing .tf files (excluding cache directories)
        TF_DIRS=$(find . -type f -name "*.tf" ! -path "*/.terragrunt-cache/*" ! -path "*/.terraform/*" -exec dirname {} \; | sort -u)
        
        if [ -z "$TF_DIRS" ]; then
          echo "âš ï¸  No Terraform files found"
          echo "status=skipped" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        echo "Found Terraform directories:"
        echo "$TF_DIRS" | sed 's/^/  /'
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        
        # Validate each directory
        while IFS= read -r dir; do
          TOTAL_DIRS=$((TOTAL_DIRS + 1))
          echo "ðŸ“‚ Validating: $dir"
          
          cd "$dir" || continue
          
          # Initialize if needed (without backend)
          if [ ! -d ".terraform" ]; then
            echo "   Initializing (backend=false)..."
            terraform init -backend=false > /dev/null 2>&1 || {
              echo "   âš ï¸  Initialization failed, skipping validation"
              cd - > /dev/null
              continue
            }
          fi
          
          # Run validation
          if terraform validate -no-color > validate_output.txt 2>&1; then
            echo "   âœ… Valid"
            VALIDATED_DIRS=$((VALIDATED_DIRS + 1))
          else
            echo "   âŒ Validation failed"
            cat validate_output.txt | sed 's/^/      /'
            VALIDATION_ERRORS=$((VALIDATION_ERRORS + 1))
            FAILED_DIRS="${FAILED_DIRS}\n  - ${dir}"
          fi
          
          rm -f validate_output.txt
          cd - > /dev/null
          echo ""
        done <<< "$TF_DIRS"
        
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ðŸ“Š Validation Summary"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "Total directories: $TOTAL_DIRS"
        echo "Successfully validated: $VALIDATED_DIRS"
        echo "Failed validations: $VALIDATION_ERRORS"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        
        # Add to GitHub summary
        echo "## ðŸ” Terraform Validation Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Total Directories | $TOTAL_DIRS |" >> $GITHUB_STEP_SUMMARY
        echo "| âœ… Validated | $VALIDATED_DIRS |" >> $GITHUB_STEP_SUMMARY
        echo "| âŒ Failed | $VALIDATION_ERRORS |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ $VALIDATION_ERRORS -eq 0 ]; then
          echo "âœ… All Terraform configurations are valid"
          echo "status=passed" >> $GITHUB_OUTPUT
        else
          echo "âŒ Validation errors found in the following directories:"
          echo -e "$FAILED_DIRS"
          echo "status=failed" >> $GITHUB_OUTPUT
          
          echo "### âŒ Failed Directories" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo -e "$FAILED_DIRS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ inputs.fail-on-validation-error }}" = "true" ]; then
            exit 1
          fi
        fi

    - name: Install Checkov
      id: install
      shell: bash
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ðŸ”’ Installing Checkov"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        if [ "${{ inputs.version }}" = "latest" ]; then
          pip install --upgrade pip
          pip install checkov
        else
          pip install --upgrade pip
          pip install checkov==${{ inputs.version }}
        fi
        
        VERSION=$(checkov --version | head -n 1)
        echo "âœ… Checkov installed successfully"
        echo "$VERSION"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    - name: Run Checkov Security Scan
      id: scan
      if: inputs.run-scan == 'true'
      shell: bash
      working-directory: ${{ inputs.workingDirectory }}
      continue-on-error: true
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ðŸ”’ Running Checkov Security Scan"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ðŸ“‚ Working Directory: $(pwd)"
        echo "ðŸŽ¯ Framework: ${{ inputs.framework }}"
        echo "ðŸ“Š Output Format: ${{ inputs.output-format }}"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        # Prepare skip checks argument
        SKIP_CHECKS="${{ inputs.checkovSkipChecks }}"
        SKIP_ARG=""
        if [ -n "${SKIP_CHECKS}" ]; then
          echo "â­ï¸  Skipping checks: ${SKIP_CHECKS}"
          SKIP_ARG="--skip-check ${SKIP_CHECKS}"
        fi
        
        # Prepare output format arguments
        OUTPUT_FORMATS="${{ inputs.output-format }}"
        OUTPUT_ARGS=""
        for format in ${OUTPUT_FORMATS//,/ }; do
          OUTPUT_ARGS="${OUTPUT_ARGS} --output ${format}"
        done
        
        # Prepare soft-fail argument
        SOFT_FAIL_ARG=""
        if [ "${{ inputs.soft-fail }}" = "true" ]; then
          SOFT_FAIL_ARG="--soft-fail"
        fi
        
        # Determine scan directory
        SCAN_DIR="."
        SCAN_TYPE="working directory"
        
        # Check if we should scan Terragrunt cache
        if [ "${{ inputs.scan-terragrunt-cache }}" = "true" ]; then
          echo "ðŸ”Ž Looking for Terragrunt cache directory..."
          
          # Find Terraform files in cache
          CACHE_DIR=$(find . -type d -name ".terragrunt-cache" -print -quit 2>/dev/null)
          
          if [ -n "${CACHE_DIR}" ]; then
            # Find the actual Terraform module directory within cache
            TF_MODULE=$(find "${CACHE_DIR}" -type f -name "*.tf" -exec dirname {} \; | head -n 1)
            
            if [ -n "${TF_MODULE}" ]; then
              SCAN_DIR="${TF_MODULE}"
              SCAN_TYPE="Terragrunt cache"
              echo "âœ… Found Terragrunt cache: ${SCAN_DIR}"
            else
              echo "âš ï¸  Terragrunt cache found but no .tf files, scanning working directory"
            fi
          else
            echo "â„¹ï¸  No Terragrunt cache found, scanning working directory"
          fi
        fi
        
        echo ""
        echo "ðŸ“ Scanning ${SCAN_TYPE}: ${SCAN_DIR}"
        echo ""
        
        # Build and run Checkov command
        CHECKOV_CMD="checkov -d \"${SCAN_DIR}\" \
          --framework ${{ inputs.framework }} \
          ${OUTPUT_ARGS} \
          --output-file-path . \
          ${SOFT_FAIL_ARG} \
          ${SKIP_ARG}"
        
        echo "ðŸš€ Executing: ${CHECKOV_CMD}"
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        
        # Run Checkov
        eval ${CHECKOV_CMD} || true
        
        # Set outputs
        echo "completed=true" >> $GITHUB_OUTPUT
        echo "scanned-dir=${SCAN_DIR}" >> $GITHUB_OUTPUT
        
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… Checkov scan completed"
        echo "ðŸ“„ Results saved to current directory"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    - name: Upload Checkov Results
      if: inputs.run-scan == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: checkov-security-report
        path: |
          ${{ inputs.workingDirectory }}/results_cli.txt
          ${{ inputs.workingDirectory }}/results_junitxml.xml
          ${{ inputs.workingDirectory }}/results_json.json
          ${{ inputs.workingDirectory }}/results_sarif.sarif
        if-no-files-found: ignore
        retention-days: 30

    - name: Generate Summary
      if: inputs.run-scan == 'true'
      shell: bash
      working-directory: ${{ inputs.workingDirectory }}
      run: |
        echo "## ðŸ”’ Checkov Security Scan Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| **Checkov Version** | \`${{ steps.install.outputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| **Scanned Directory** | \`${{ steps.scan.outputs.scanned-dir }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| **Framework** | \`${{ inputs.framework }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| **Output Formats** | \`${{ inputs.output-format }}\` |" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ inputs.validate-terraform }}" = "true" ]; then
          echo "| **Terraform Validation** | \`${{ steps.tf-validate.outputs.status }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Terraform Formatting** | \`${{ steps.tf-format.outputs.status }}\` |" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -n "${{ inputs.checkovSkipChecks }}" ]; then
          echo "| **Skipped Checks** | \`${{ inputs.checkovSkipChecks }}\` |" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“Š Security scan results have been uploaded as artifacts." >> $GITHUB_STEP_SUMMARY